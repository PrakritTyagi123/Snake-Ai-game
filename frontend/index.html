<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snake AI Trainer</title>
  <link rel="stylesheet" href="style.css" />
  <script defer src="https://d3js.org/d3.v7.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="app-header">
    <h1>Snake AI Trainer</h1>
    <div id="saveIndicator" class="save-indicator hidden" aria-live="polite">Saving…</div>
  </header>

  <main class="layout">
    <!-- LEFT COLUMN -->
    <div class="left-stack">
      <section id="gamePanel" class="panel" aria-labelledby="game-title">
        <h2 id="game-title" class="panel-title">Game</h2>

        <!-- Grid size + Algorithm (inline) -->
        <div class="panel-sub grid-size-row">
          <label for="gridSizeSelect" class="grid-label">Grid size</label>
          <select id="gridSizeSelect" class="grid-select" aria-label="Grid size">
            <option value="5">5 × 5</option>
            <option value="8">8 × 8</option>
            <option value="10">10 × 10</option>
            <option value="12">12 × 12</option>
            <option value="20" selected>20 × 20</option>
          </select>

          <div class="algo-inline">
            <label for="algoSelect" class="algo-label">Algorithm</label>
            <select id="algoSelect" class="algo-select" aria-label="Algorithm">
              <option value="DDQN" selected>DDQN</option>
              <option value="DQN">DQN</option>
              <option value="PPO">PPO</option>
              <option value="A2C">A2C</option>
            </select>
          </div>

          <span class="grid-hint">Changes apply at next episode.</span>
        </div>

        <div class="game-wrap">
          <canvas id="gameCanvas" width="600" height="600" aria-label="Game Window"></canvas>

          <div id="overlayWin" class="overlay overlay-win" aria-live="polite" aria-hidden="true">
            <div class="overlay-content">YOU WIN!</div>
          </div>
          <div id="overlayLoss" class="overlay overlay-loss" aria-live="polite" aria-hidden="true">
            <div class="overlay-content">
              <div>GAME OVER</div>
              <div id="lossReason" class="overlay-sub"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- LLM Commentary -->
      <section id="llmPanel" class="panel" aria-live="polite">
        <h2 class="panel-title">LLM Commentary</h2>
        <div id="llmFeed" class="llm-feed"></div>
      </section>
    </div>

    <!-- RIGHT COLUMN -->
    <section class="right-rail panel">
      <div class="panel-sub header-with-toggle">
        <div class="toggle-group" role="tablist" aria-label="Visualization Toggle">
          <button id="viewToggleNone" class="toggle red" role="tab" aria-selected="false">Nothing</button>
          <button id="viewToggleNeural" class="toggle red active" role="tab" aria-selected="true">Neural Network</button>
          <button id="viewToggleGraphs" class="toggle red" role="tab" aria-selected="false">Graphs</button>
        </div>
        <h2 class="panel-title">Visual Representation</h2>
      </div>

      <div id="nnVisualization" class="panel-sub viz-box" aria-live="polite">
        <svg id="nnSvg" class="nn-svg" width="100%" height="360" preserveAspectRatio="xMidYMid meet" aria-label="Neural Network Diagram"></svg>
      </div>

      <div id="graphsPanel" class="panel-sub viz-box hidden" aria-live="polite" aria-hidden="true">
        <div class="charts-grid">
          <canvas id="scoreChart" height="120"></canvas>
          <canvas id="epsilonChart" height="120"></canvas>
          <canvas id="lossChart" height="120"></canvas>
        </div>
      </div>

      <div class="panel-sub controls-panel">
        <h2 class="panel-title">Controls</h2>

        <div class="buttons-row">
          <button id="startBtn" class="btn">Start</button>
          <button id="pauseBtn" class="btn">Pause</button>
          <button id="resumeBtn" class="btn">Resume</button>
          <button id="stopBtn" class="btn destructive">Stop</button>
          <button id="resetBtn" class="btn">Reset</button>
          <button id="saveBtn" class="btn ghost">Save Model</button>
          <button id="loadBtn" class="btn ghost">Load Model</button>
          <button id="closeBtn" class="btn destructive">Close Project</button>
          <span id="runStatus" class="status-pill">Stopped</span>
        </div>

        <div class="sliders-grid">
          <div class="control">
            <label for="epsilonSlider">Epsilon Decay: <span id="epsilonVal" class="val">0.9950</span></label>
            <input id="epsilonSlider" type="range" min="0.90" max="0.9999" step="0.0005" value="0.995">
          </div>
          <div class="control">
            <label for="lrSlider">Learning Rate: <span id="lrVal" class="val">0.0010</span></label>
            <input id="lrSlider" type="range" min="0.0001" max="0.01" step="0.0001" value="0.001">
          </div>
          <div class="control">
            <label for="gammaSlider">Discount γ: <span id="gammaVal" class="val">0.95</span></label>
            <input id="gammaSlider" type="range" min="0.50" max="0.99" step="0.01" value="0.95">
          </div>
          <div class="control">
            <label for="batchSlider">Batch Size: <span id="batchVal" class="val">64</span></label>
            <input id="batchSlider" type="range" min="16" max="256" step="16" value="64">
          </div>
          <div class="control">
            <label for="speedSlider">Speed (ms per step): <span id="speedVal" class="val">0</span></label>
            <input id="speedSlider" type="range" min="0" max="250" step="5" value="0">
          </div>
        </div>
      </div>

      <div class="panel-sub table-panel">
        <h2 class="panel-title">Episode Analysis</h2>
        <div class="table-wrap" role="region" aria-label="Analysis Table">
          <table id="analysisTable">
            <thead>
              <tr>
                <th>Episode</th>
                <th>Outcome</th>
                <th>Reason of Death</th>
                <th>Score</th>
                <th>Snake Length</th>
                <th>Epsilon</th>
                <th>Avg Loss</th>
                <th>Steps</th>
                <th>Duration (ms)</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>window.__CONFIG__ = { API_URL: "http://127.0.0.1:5000", WS_URL: "ws://127.0.0.1:5000/ws/stream" };</script>
  <script defer src="script.js"></script>
</body>
</html>
